import java.awt.Dimension;
import java.awt.Toolkit;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.concurrent.TimeUnit;

import javax.imageio.ImageIO;

import com.github.sarxos.webcam.Webcam;
import com.github.sarxos.webcam.WebcamStreamer;
import com.xuggle.mediatool.IMediaWriter;
import com.xuggle.mediatool.ToolFactory;
import com.xuggle.xuggler.ICodec;


public class Server {

	private static Dimension screenBounds;
    public static int indexVideo = 1;
    private static final double FRAME_RATE = 15;

    private static final int SECONDS_TO_RUN_FOR = 20;
    private static final String OUTPUT_FILE = "./test.mp4";
    private static final Webcam webcam = Webcam.getDefault();
	
	public static void main(String[] args) {
		webcam.setViewSize(new Dimension(640, 480));
		new WebcamStreamer(8081, webcam, 20, true);

        final IMediaWriter writer = ToolFactory.makeWriter(OUTPUT_FILE);
        screenBounds = Toolkit.getDefaultToolkit().getScreenSize();
        writer.addVideoStream(0, 0, ICodec.ID.CODEC_ID_MPEG4,
                screenBounds.width / 2, screenBounds.height / 2);
        long startTime = System.nanoTime();

        for (int index = 0; index < SECONDS_TO_RUN_FOR*FRAME_RATE; index++) {
        	long frameStart = System.nanoTime();
            BufferedImage bgrScreen = webcam.getImage();
            System.out.println("time stamp = "+ (System.nanoTime() - startTime));
            bgrScreen = convertToType(bgrScreen, BufferedImage.TYPE_3BYTE_BGR);
            // encode the image to stream #0
            //writer.encodeVideo(0, bgrScreen, (System.nanoTime() - startTime)/2,TimeUnit.NANOSECONDS);
            // encode the image to stream #0
            writer.encodeVideo(0, bgrScreen, System.nanoTime() - startTime,
                    TimeUnit.NANOSECONDS);
            // sleep for frame rate milliseconds
            System.out.println("Timeout"+(1000.0/FRAME_RATE - (System.nanoTime()-frameStart)/1000.0));
            
            try {
                Thread.sleep((long) (1000.0/FRAME_RATE - (System.nanoTime()-frameStart)/1000.0));
            } catch (InterruptedException e) {
                // ignore
            }
        }
        writer.close();
    }

    public static BufferedImage convertToType(BufferedImage sourceImage,
	            int targetType) {

        BufferedImage image;

        // if the source image is already the target type, return the source
        // image
        if (sourceImage.getType() == targetType) {
            image = sourceImage;
        }
        // otherwise create a new image of the target type and draw the new
        // image
        else {
            image = new BufferedImage(sourceImage.getWidth(),
                    sourceImage.getHeight(), targetType);
            image.getGraphics().drawImage(sourceImage, 0, 0, null);
        }

        return image;

	}
}
